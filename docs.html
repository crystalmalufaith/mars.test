<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Mars.ai - AI Generated Documents</title>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/katex.min.css">
<script src="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/katex.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/contrib/auto-render.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/pako@2.1.0/dist/pako.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
<script>
  pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
</script>

<link rel="stylesheet" href="style.css">
<style>
.google-docs-modal .modal-content,
.content-modal .modal-content {
  background: #1a1a1a;
  border: none;
  border-radius: 8px;
}

.google-docs-modal .modal-content {
  max-width: none;
  width: 90vw;
  height: 90vh;
  padding: 0;
}

.google-docs-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 1rem;
  background: #f1f3f4;
  border-bottom: 1px solid #dadce0;
}

.google-docs-header h2 {
  color: black;
  margin: 0;
}

.google-docs-paper {
  background: white;
  margin: 2rem auto;
  width: 595px; /* A4 width at 72 DPI */
  min-height: 842px; /* A4 height at 72 DPI */
  max-height: none; /* Allow content to exceed for multiple pages */
  box-shadow: 0 0 10px rgba(0,0,0,0.1);
  border: 1px solid #dadce0;
  position: relative;
  padding: 2rem; /* Padding all around */
}

.google-docs-paper::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 20px;
  background: #f1f3f4;
  border-bottom: 1px solid #dadce0;
}

.doc-actions {
  display: flex;
  gap: 0.5rem;
}

#document-content, #document-content * {
  color: black !important;
}

#document-content h1 {
  font-size: 24pt;
  font-weight: normal;
  margin-top: 16pt;
  margin-bottom: 6pt;
  page-break-after: avoid;
}

#document-content h2 {
  font-size: 18pt;
  font-weight: normal;
  margin-top: 14pt;
  margin-bottom: 4pt;
  page-break-after: avoid;
}

#document-content h3 {
  font-size: 14pt;
  font-weight: normal;
  margin-top: 12pt;
  margin-bottom: 4pt;
  page-break-after: avoid;
}

#document-content p {
  margin-bottom: 1em;
  orphans: 2;
  widows: 2;
}

#document-content ul, #document-content ol {
  margin-bottom: 1em;
  padding-left: 2em;
}

#document-content strong, #document-content b {
  font-weight: bold;
}

#document-content em, #document-content i {
  font-style: italic;
}

#document-content u {
  text-decoration: underline;
}

#document-content .katex {
  font-size: 1em;
}

/* Content modal form styling */
.content-modal input[type="text"],
.content-modal textarea,
.content-modal select {
  background: #2a2a2a;
  border: 1px solid #555;
  color: #e0e0e0;
  padding: 0.5rem;
  border-radius: 4px;
  width: 100%;
  margin-bottom: 1rem;
}

.content-modal input[type="text"]:focus,
.content-modal textarea:focus,
.content-modal select:focus {
  outline: none;
  border-color: #6c757d;
}

.content-modal label {
  color: #e0e0e0;
  margin-bottom: 0.5rem;
  display: block;
}

.content-modal button {
  background: #6c757d;
  color: white;
  border: none;
  padding: 0.75rem 1.5rem;
  border-radius: 4px;
  cursor: pointer;
  margin-right: 0.5rem;
}

.content-modal button:hover {
  background: #5a6268;
}

.google-docs-modal button {
  background: #6c757d;
  color: white;
  border: none;
  padding: 0.5rem 1rem;
  border-radius: 4px;
  cursor: pointer;
  margin-right: 0.5rem;
}

.google-docs-modal button:hover {
  background: #5a6268;
}

.google-docs-modal .modal-actions {
  padding: 1rem;
  background: #1a1a1a;
  border-top: 1px solid #333;
  display: flex;
  justify-content: flex-end;
}

/* Document list buttons */
.doc-card button {
  background: #6c757d;
  color: white;
  border: none;
  padding: 0.5rem 1rem;
  border-radius: 4px;
  cursor: pointer;
  margin-right: 0.5rem;
}

.doc-card button:hover {
  background: #5a6268;
}

.doc-card button.delete {
  background: #6c757d;
}

.doc-card button.delete:hover {
  background: #5a6268;
}

.back-btn {
  background: #f1f3f4 !important;
  color: #3c4043 !important;
  border: 1px solid #dadce0 !important;
  padding: 0.5rem 1rem !important;
  border-radius: 4px !important;
  cursor: pointer !important;
  margin-bottom: 1rem !important;
  font-size: 14px !important;
}

.back-btn:hover {
  background: #e8eaed !important;
}

/* Formatting Toolbar Styles */
#formatting-toolbar {
  position: sticky;
  top: 0;
  left: 0;
  right: 0;
  gap: 0.5rem;
  align-items: center;
  flex-wrap: wrap;
  background: transparent;
  padding: 0.5rem;
  margin-bottom: 1rem;
  z-index: 1000;
  width: 100vw;
  box-sizing: border-box;
}

#formatting-toolbar button {
  background: #6c757d;
  color: white;
  border: none;
  padding: 0.5rem 0.75rem;
  border-radius: 4px;
  cursor: pointer;
  font-size: 14px;
  font-weight: bold;
  min-width: 35px;
}

#formatting-toolbar button:hover {
  background: #5a6268;
}

#formatting-toolbar button.active {
  background: #495057;
}

#formatting-toolbar select {
  background: #2a2a2a;
  border: 1px solid #555;
  color: #e0e0e0;
  padding: 0.5rem;
  border-radius: 4px;
  font-size: 14px;
  font-weight: bold;
}
</style>
</head>
<body>

<div class="header">
  <button id="sidebar-toggle" style="background: none; border: none; color: white; font-size: 24px; cursor: pointer;">☰</button>
  <h1>Mars.ai</h1>
  <div></div>
</div>

<div class="sidebar">
  <nav class="nav">
    <a href="index.html">AI Tutor</a>
    <a href="decks.html">Decks</a>
    <a href="docs.html">Docs</a>
    <a href="quiz.html">Quiz</a>
    <a href="stats.html">Stats</a>
    <a href="community.html">Community</a>
    <a href="about.html">About</a>
    <a href="terms.html">Terms</a>
    <a href="#" id="account-link">Account</a>
  </nav>
</div>

<div class="main-section">
 <div class="main-container" id="list-view">
   <div class="page-header">
     <h1>AI Generated Documents</h1>
   </div>


   <div class="create-doc">
     <button id="generate-doc-btn" style="margin-bottom: 1rem; padding: 0.75rem 1.5rem; background: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer;">Generate Document from Content</button>
   </div>

   <div class="documents-list" id="documents-container">
     <!-- Generated documents will be displayed here -->
   </div>
 </div>

  <div class="main-container" id="document-view" style="display: none;">
     <div class="page-header">
       <button onclick="backToList()" class="back-btn">← Back to Documents</button>
       <h1 id="view-doc-title">Document Title</h1>
       <div class="doc-actions">
         <button onclick="toggleEditMode()" id="edit-btn">Edit</button>
         <button onclick="shareDocument()" id="share-btn">Share</button>
         <button onclick="regenerateDocument()" id="regenerate-btn" style="display: none;">Regenerate with AI</button>
         <button onclick="saveDocumentChanges()" id="save-changes-btn" style="display: none;">Save Changes</button>
       </div>
     </div>

     <!-- Formatting Toolbar -->
     <div id="formatting-toolbar" style="display: block; background: transparent; border: none; padding: 0.5rem; margin-bottom: 1rem; border-radius: 4px;">
       <button onclick="formatText('bold')" title="Bold">B</button>
       <button onclick="formatText('italic')" title="Italic">I</button>
       <button onclick="formatText('underline')" title="Underline">U</button>
       <select onchange="formatText('fontSize', this.value)" title="Font Size">
         <option value="1">8pt</option>
         <option value="2">10pt</option>
         <option value="3" selected>12pt</option>
         <option value="4">14pt</option>
         <option value="5">18pt</option>
         <option value="6">24pt</option>
         <option value="7">36pt</option>
       </select>
       <select onchange="formatText('fontName', this.value)" title="Font Family">
         <option value="Arial" selected>Arial</option>
         <option value="Times New Roman">Times New Roman</option>
         <option value="Courier New">Courier New</option>
         <option value="Georgia">Georgia</option>
         <option value="Verdana">Verdana</option>
       </select>
     </div>


     <div class="google-docs-paper" id="document-paper">
       <div id="document-content" contenteditable="false" style="padding: 2rem; min-height: 100%; outline: none; font-family: Arial, sans-serif; font-size: 12pt; line-height: 1.5;"></div>
     </div>
   </div>
</div>

<div class="modal" id="content-modal">
  <div class="modal-content">
    <h2>Generate Document from Content</h2>
    <form id="content-form">
      <label for="doc-title">Document Title:</label>
      <input type="text" id="doc-title" placeholder="Enter document title" required>
      <label for="content-text">Paste Text:</label>
      <textarea id="content-text" placeholder="Paste your text here..." rows="5"></textarea>
      <label for="content-file">Upload Image or PDF:</label>
      <input type="file" id="content-file" accept=".txt,.pdf,.jpg,.png,.jpeg">
      <div id="loading-indicator" style="display: none; color: #e0e0e0; text-align: center; margin: 1rem 0;">Generating document...</div>
      <div class="modal-actions">
        <button type="button" onclick="closeContentModal()">Cancel</button>
        <button type="submit" id="generate-btn">Generate Document</button>
      </div>
    </form>
  </div>
</div>


<div class="modal" id="regenerate-modal">
  <div class="modal-content">
    <h2>Regenerate Document with AI</h2>
    <div>
      <label for="regenerate-prompt" style="color: #e0e0e0; margin-bottom: 0.5rem; display: block;">Enter instructions for regenerating:</label>
      <textarea id="regenerate-prompt" placeholder='e.g., "Make it more detailed" or "Simplify the language"' rows="3" style="width: 100%; padding: 0.5rem; border: 1px solid #444; border-radius: 4px; background: #222; color: #e0e0e0; margin-bottom: 1rem;"></textarea>
      <div id="regenerate-loading" style="display: none; color: #e0e0e0; text-align: center; margin: 1rem 0;">Regenerating document...</div>
      <div class="modal-actions">
        <button type="button" onclick="closeRegenerateModal()" class="add-flashcard-btn">Cancel</button>
        <button type="button" onclick="submitRegenerate()" class="add-flashcard-btn">Regenerate Document</button>
      </div>
    </div>
  </div>
</div>

<div class="modal" id="account-modal">
  <div class="modal-content">
    <h2>Account</h2>
    <div id="account-info">
      <!-- Account info will be loaded here -->
    </div>
  </div>
</div>

<script>
const user = JSON.parse(localStorage.getItem('currentUser'));
if (!user) {
  window.location.href = 'sign-in.html?redirect=' + encodeURIComponent(window.location.href);
}

let documents = JSON.parse(localStorage.getItem('generatedDocuments_' + user.id)) || [];
let currentDocId = null;

function generateRandomId() {
  const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
  let result = '';
  for (let i = 0; i < 20; i++) {
    result += chars.charAt(Math.floor(Math.random() * chars.length));
  }
  return result;
}

function saveDocuments() {
  localStorage.setItem('generatedDocuments_' + user.id, JSON.stringify(documents));
}

function renderDocuments() {
  const container = document.getElementById('documents-container');
  container.innerHTML = '';

  if (documents.length === 0) {
    container.innerHTML = '<p style="text-align: center; color: #666;">No documents generated yet. Create your first document!</p>';
    return;
  }

  documents.forEach((doc, index) => {
    const docCard = document.createElement('div');
    docCard.className = 'doc-card';
    docCard.innerHTML = `
      <h3>${doc.title}</h3>
      <p>Generated on ${new Date(doc.date).toLocaleDateString()}</p>
      <div class="doc-actions">
        <button onclick="viewDocument(${index})">View</button>
        <button onclick="shareDocumentByIndex(${index})">Share</button>
        <button class="delete" onclick="deleteDocument(${index})">Delete</button>
      </div>
    `;
    container.appendChild(docCard);
  });
}

let currentDocIndex = null;

function viewDocument(index) {
  const doc = documents[index];
  history.pushState(null, '', `docs.html?doc=${doc.id}`);
  showDocumentView(doc);
}

function deleteDocument(index) {
  if (confirm('Are you sure you want to delete this document?')) {
    documents.splice(index, 1);
    saveDocuments();
    renderDocuments();
  }
}


function toggleEditMode() {
  const contentDiv = document.getElementById('document-content');
  const editBtn = document.getElementById('edit-btn');
  const regenerateBtn = document.getElementById('regenerate-btn');
  const saveBtn = document.getElementById('save-changes-btn');
  const toolbar = document.getElementById('formatting-toolbar');

  if (contentDiv.contentEditable === 'true') {
    // Exit edit mode
    contentDiv.contentEditable = 'false';
    editBtn.textContent = 'Edit';
    regenerateBtn.style.display = 'none';
    saveBtn.style.display = 'none';
    toolbar.style.display = 'none';
  } else {
    // Enter edit mode
    contentDiv.contentEditable = 'true';
    contentDiv.focus();
    editBtn.textContent = 'Stop Editing';
    regenerateBtn.style.display = 'inline-block';
    saveBtn.style.display = 'inline-block';
    toolbar.style.display = 'block';
    updateToolbarStates();
  }
}

function updateToolbarStates() {
  const buttons = document.querySelectorAll('#formatting-toolbar button');
  buttons.forEach(button => {
    const match = button.onclick.toString().match(/formatText\('(\w+)'/);
    if (match) {
      const command = match[1];
      if (document.queryCommandState(command)) {
        button.classList.add('active');
      } else {
        button.classList.remove('active');
      }
    }
  });
}

function formatText(command, value = null) {
  document.execCommand(command, false, value);
  document.getElementById('document-content').focus();
  updateToolbarStates();
}

function saveDocumentChanges() {
  if (currentDocId === null) return;

  const contentDiv = document.getElementById('document-content');
  const newContent = contentDiv.innerHTML; // Save as HTML

  const doc = documents.find(d => d.id === currentDocId);
  if (doc) {
    doc.content = newContent;
    saveDocuments();
    alert('Changes saved!');
  }
}

async function shareDocument() {
  let doc;
  if (currentDocId !== null) {
    doc = documents.find(d => d.id === currentDocId);
  } else {
    // For shared documents, create a temp doc from current content
    const title = document.getElementById('view-doc-title').textContent;
    const content = document.getElementById('document-content').innerHTML;
    doc = { title, content };
  }
  if (!doc) return;

  await shareDoc(doc);
}

async function shareDocumentByIndex(index) {
  const doc = documents[index];
  if (!doc) return;

  await shareDoc(doc);
}

async function shareDoc(doc) {
  const shareData = {
    title: doc.title,
    content: doc.content
  };
  const json = JSON.stringify(shareData);
  const gzipped = pako.gzip(json);
  const base64 = btoa(String.fromCharCode(...gzipped));
  const compressed = encodeURIComponent(base64);
  const longUrl = `${window.location.origin}${window.location.pathname}#shared=${compressed}`;

  try {
    const shortResponse = await fetch(`https://is.gd/create.php?format=simple&url=${encodeURIComponent(longUrl)}`);
    const shortUrl = await shortResponse.text();
    navigator.clipboard.writeText(shortUrl).then(() => {
      alert('Share link copied to clipboard!');
    }).catch(() => {
      alert(`Share this link: ${shortUrl}`);
    });
  } catch (e) {
    // Fallback to long URL if shortener fails
    navigator.clipboard.writeText(longUrl).then(() => {
      alert('Share link copied to clipboard!');
    }).catch(() => {
      alert(`Share this link: ${longUrl}`);
    });
  }
}


function regenerateDocument() {
  if (currentDocId === null) return;
  document.getElementById('regenerate-modal').classList.add('show');
  document.getElementById('regenerate-prompt').focus();
}

function closeRegenerateModal() {
  document.getElementById('regenerate-modal').classList.remove('show');
  document.getElementById('regenerate-prompt').value = '';
}

// Handle Enter key in regenerate modal
document.getElementById('regenerate-prompt').addEventListener('keydown', function(e) {
  if (e.key === 'Enter' && !e.shiftKey) {
    e.preventDefault();
    submitRegenerate();
  }
});

async function submitRegenerate() {
  const prompt = document.getElementById('regenerate-prompt').value.trim();
  if (!prompt) return;

  const contentDiv = document.getElementById('document-content');
  const currentContent = contentDiv.innerText; // Get text for AI

  // Close modal and show loading
  closeRegenerateModal();
  contentDiv.innerHTML = 'Regenerating...';
  document.getElementById('regenerate-btn').disabled = true;

  try {
    const response = await fetch('https://api.groq.com/openai/v1/chat/completions', {
      method: 'POST',
      headers: {
        'Authorization': 'Bearer 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',
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        model: "meta-llama/llama-4-maverick-17b-128e-instruct",
        messages: [{"role": "user", "content": `Modify this document based on the following instructions: "${prompt}". Keep the markdown formatting with headings, bold, italics, etc. Original document: ${currentContent}`}],
        temperature: 0.5,
        max_tokens: 2000,
        top_p: 1,
        stream: false,
        stop: null
      }),
    });

    if (!response.ok) {
      throw new Error(`HTTP ${response.status}`);
    }

    const data = await response.json();
    const newContent = data.choices[0]?.message?.content || currentContent;

    contentDiv.innerHTML = marked.parse(newContent);

    // Render math
    renderMathInElement(contentDiv, {
      delimiters: [
        {left: "$$", right: "$$", display: true},
        {left: "$", right: "$", display: false},
        {left: "\\(", right: "\\)", display: false}
      ]
    });

    // Update stored content
    const doc = documents.find(d => d.id === currentDocId);
    if (doc) {
      doc.content = contentDiv.innerHTML;
      saveDocuments();
    }

  } catch (error) {
    alert('Error regenerating document: ' + error.message);
    const doc = documents.find(d => d.id === currentDocId);
    if (doc) {
      contentDiv.innerHTML = doc.content;
    }
  } finally {
    document.getElementById('regenerate-btn').disabled = false;
  }
}


// Generate document
document.getElementById('generate-doc-btn').addEventListener('click', () => {
  openContentModal();
});

function openContentModal() {
  document.getElementById('content-modal').classList.add('show');
}

function closeContentModal() {
  document.getElementById('content-modal').classList.remove('show');
}

// Content form submit
document.getElementById('content-form').addEventListener('submit', async (e) => {
  e.preventDefault();
  const title = document.getElementById('doc-title').value.trim();
  const text = document.getElementById('content-text').value.trim();
  const fileInput = document.getElementById('content-file');
  const loading = document.getElementById('loading-indicator');
  const generateBtn = document.getElementById('generate-btn');

  let content = text;

  if (fileInput.files.length > 0) {
    const file = fileInput.files[0];
    if (file.type === 'application/pdf') {
      content = await extractPDFText(file);
    } else if (file.type.startsWith('image/')) {
      alert('Image processing not yet supported. Please paste text instead.');
      return;
    } else {
      alert('Unsupported file type.');
      return;
    }
  }

  if (!content) {
    alert('Please provide text or upload a PDF.');
    return;
  }

  // Show loading
  loading.style.display = 'block';
  generateBtn.disabled = true;
  generateBtn.textContent = 'Generating...';

  try {
    // Generate document
    const docContent = await generateDocument(content);

    // Parse markdown to HTML for storage
    const htmlContent = marked.parse(docContent);

    // Generate random ID
    const docId = generateRandomId();

    // Add to documents
    const newDoc = {
      id: docId,
      title: title,
      content: htmlContent,
      date: new Date().toISOString()
    };
    documents.push(newDoc);
    saveDocuments();
    renderDocuments();
    closeContentModal();

    // Show the generated document
    viewDocument(documents.length - 1);
  } catch (error) {
    alert('Error generating document: ' + error.message);
  } finally {
    // Hide loading
    loading.style.display = 'none';
    generateBtn.disabled = false;
    generateBtn.textContent = 'Generate Document';
  }
});

async function extractPDFText(file) {
  const pdfjsLib = window['pdfjsLib'];
  pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

  const pdf = await pdfjsLib.getDocument(URL.createObjectURL(file)).promise;
  let text = '';
  for (let i = 1; i <= Math.min(pdf.numPages, 50); i++) {
    const page = await pdf.getPage(i);
    const content = await page.getTextContent();
    text += content.items.map(item => item.str).join(' ') + '\n';
  }
  return text;
}

async function generateDocument(text) {
  try {
    const response = await fetch('https://api.groq.com/openai/v1/chat/completions', {
      method: 'POST',
      headers: {
        'Authorization': 'Bearer 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',
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        model: "meta-llama/llama-4-maverick-17b-128e-instruct",
        messages: [{"role": "user", "content": `Create a comprehensive, detailed study guide or reviewer document from this text. Make it long enough to fill multiple pages (aim for 3000+ words). Use extensive formatting throughout:
- Headings: # Main Title, ## Section, ### Subsection, #### Sub-subsection
- Text formatting: **bold** for important terms and concepts, *italics* for emphasis and definitions, <u>underlined text</u> for key points and formulas
- Lists: - bullet points for examples, 1. numbered lists for steps
- Include LaTeX math expressions extensively if the content involves math (e.g., $x^2$, $\\frac{a}{b}$, $$\\int f(x) dx$$)
- Tables if appropriate using markdown table syntax
Structure it logically with clear sections, subsections, and sub-subsections. Make it educational, well-organized, and visually appealing with proper formatting. Include summaries, examples, and practice questions where relevant. Use ALL these formatting elements liberally throughout the document. ${text}`}],
        temperature: 0.5,
        max_tokens: 4000,
        top_p: 1,
        stream: false,
        stop: null
      }),
    });

    if (!response.ok) {
      throw new Error(`HTTP ${response.status}`);
    }

    const data = await response.json();
    const content = data.choices[0]?.message?.content || 'No content generated.';
    return content;
  } catch (error) {
    console.error('Document generation failed:', error);
    return 'Error generating document.';
  }
}

// Account modal functions
let outsideClickHandler;

function openAccountModal() {
  const modal = document.getElementById('account-modal');
  const info = document.getElementById('account-info');
  const user = JSON.parse(localStorage.getItem('currentUser'));
  if (user) {
    info.innerHTML = `<p>Signed in as: ${user.name}</p><button class="auth-btn" onclick="logout()">Logout</button><br><button onclick="closeAccountModal()" style="background: none; border: none; color: #6c757d; cursor: pointer; margin: 1rem auto 0; display: block; text-align: center;">Close</button>`;
  } else {
    info.innerHTML = `<p>Not signed in</p><button class="auth-btn" onclick="window.location.href='sign-in.html'">Sign In</button><br><button onclick="closeAccountModal()" style="background: none; border: none; color: #6c757d; cursor: pointer; margin: 1rem auto 0; display: block; text-align: center;">Close</button>`;
  }
  modal.classList.add('show');
  outsideClickHandler = function(e) {
    if (e.target.id === 'account-modal') {
      closeAccountModal();
    }
  };
  document.addEventListener('click', outsideClickHandler);
}

function closeAccountModal() {
  document.getElementById('account-modal').classList.remove('show');
  if (outsideClickHandler) {
    document.removeEventListener('click', outsideClickHandler);
    outsideClickHandler = null;
  }
}

function logout() {
  localStorage.removeItem('currentUser');
  closeAccountModal();
  window.location.href = 'sign-in.html';
}

// Event listener for account link
document.getElementById('account-link').addEventListener('click', function(e) {
  e.preventDefault();
  openAccountModal();
});

// Sidebar toggle
document.getElementById('sidebar-toggle').addEventListener('click', () => {
  document.body.classList.toggle('sidebar-open');
  localStorage.setItem('sidebarOpen', document.body.classList.contains('sidebar-open'));
});

// Initialize sidebar state
if (localStorage.getItem('sidebarOpen') === 'true') {
  document.body.classList.add('sidebar-open');
}
document.body.classList.add('sidebar-initialized');

// Close sidebar when clicking outside
document.addEventListener('click', (e) => {
  const sidebar = document.querySelector('.sidebar');
  const toggle = document.getElementById('sidebar-toggle');
  const accountModal = document.getElementById('account-modal');
  const regenerateModal = document.getElementById('regenerate-modal');
  if (!sidebar.contains(e.target) && !toggle.contains(e.target) && document.body.classList.contains('sidebar-open') && !accountModal.classList.contains('show') && !regenerateModal.classList.contains('show')) {
    document.body.classList.remove('sidebar-open');
    localStorage.setItem('sidebarOpen', false);
  }

  // Close modals when clicking outside
  if (e.target === accountModal) {
    closeAccountModal();
  }
  if (e.target === regenerateModal) {
    closeRegenerateModal();
  }
});

// Check for document ID in URL
function checkUrlParams() {
  const urlParams = new URLSearchParams(window.location.search);
  const docId = urlParams.get('doc');
  const hash = window.location.hash;
  const shared = hash.startsWith('#shared=') ? hash.substring(8) : null;

  if (shared) {
    try {
      const base64 = decodeURIComponent(shared);
      const binaryString = atob(base64);
      const gzipped = new Uint8Array(binaryString.length);
      for (let i = 0; i < binaryString.length; i++) {
        gzipped[i] = binaryString.charCodeAt(i);
      }
      const decompressed = pako.ungzip(gzipped, {to: 'string'});
      const shareData = JSON.parse(decompressed);
      showSharedDocumentView(shareData);
    } catch (e) {
      alert('Invalid share link');
      showListView();
    }
  } else if (docId) {
    const doc = documents.find(d => d.id === docId);
    if (doc) {
      showDocumentView(doc);
    } else {
      // Document not found, redirect to list
      window.location.href = 'docs.html';
    }
  } else {
    showListView();
  }
}

function showListView() {
  document.getElementById('list-view').style.display = 'block';
  document.getElementById('document-view').style.display = 'none';

  // Show header and sidebar
  document.querySelector('.header').style.display = 'flex';
  document.querySelector('.sidebar').style.display = 'block';
  document.querySelector('.main-section').style.marginLeft = '';

  renderDocuments();
}

function showSharedDocumentView(shareData) {
  currentDocId = null; // Prevent editing
  document.getElementById('list-view').style.display = 'none';
  document.getElementById('document-view').style.display = 'block';
  document.getElementById('view-doc-title').textContent = shareData.title;
  document.getElementById('document-content').innerHTML = shareData.content;

  // Hide header and sidebar for full document view
  document.querySelector('.header').style.display = 'none';
  document.querySelector('.sidebar').style.display = 'none';
  document.querySelector('.main-section').style.marginLeft = '0';

  // Hide edit and regenerate buttons for shared view, but keep share button
  document.getElementById('edit-btn').style.display = 'none';
  document.getElementById('regenerate-btn').style.display = 'none';
  document.getElementById('save-changes-btn').style.display = 'none';
  document.getElementById('formatting-toolbar').style.display = 'none';
  // Share button remains visible for further sharing

  // Ensure content is not editable
  document.getElementById('document-content').contentEditable = 'false';

  // Render math if present
  renderMathInElement(document.getElementById('document-content'), {
    delimiters: [
      {left: "$$", right: "$$", display: true},
      {left: "$", right: "$", display: false},
      {left: "\\(", right: "\\)", display: false}
    ]
  });

  // Automatically add to community
  addSharedDocumentToCommunity(shareData);
}

function addSharedDocumentToCommunity(shareData) {
  let sharedDocuments = JSON.parse(localStorage.getItem('sharedDocuments')) || [];
  // Check if already in community
  if (sharedDocuments.some(d => d.title === shareData.title && d.content === shareData.content)) {
    return; // Already added
  }

  const sharedDoc = {
    id: 'shared-' + Date.now(),
    title: shareData.title,
    content: shareData.content,
    sharedBy: 'Shared Link',
    date: new Date().toISOString()
  };

  sharedDocuments.push(sharedDoc);
  localStorage.setItem('sharedDocuments', JSON.stringify(sharedDocuments));
}

function showDocumentView(doc) {
  currentDocId = doc.id;
  document.getElementById('list-view').style.display = 'none';
  document.getElementById('document-view').style.display = 'block';
  document.getElementById('view-doc-title').textContent = doc.title;
  document.getElementById('document-content').innerHTML = doc.content;

  // Hide header and sidebar for full document view
  document.querySelector('.header').style.display = 'none';
  document.querySelector('.sidebar').style.display = 'none';
  document.querySelector('.main-section').style.marginLeft = '0';

  // Reset edit mode
  document.getElementById('document-content').contentEditable = 'false';
  document.getElementById('edit-btn').textContent = 'Edit';
  document.getElementById('regenerate-btn').style.display = 'none';
  document.getElementById('save-changes-btn').style.display = 'none';
  document.getElementById('formatting-toolbar').style.display = 'none';

  // Render math if present
  renderMathInElement(document.getElementById('document-content'), {
    delimiters: [
      {left: "$$", right: "$$", display: true},
      {left: "$", right: "$", display: false},
      {left: "\\(", right: "\\)", display: false}
    ]
  });
}

function backToList() {
  history.pushState(null, '', 'docs.html');
  showListView();
}

// Handle browser back/forward
window.addEventListener('popstate', function(event) {
  checkUrlParams();
});

// Initial render
checkUrlParams();
</script>

<script>
  const toggle = document.getElementById('sidebar-toggle');
  toggle.addEventListener('click', () => {
    document.body.classList.toggle('sidebar-closed');
  });
</script>

</body>
</html>
