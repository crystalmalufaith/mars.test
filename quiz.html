<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Mars.ai - AI Quizzes</title>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/katex.min.css">
<script src="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/katex.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/contrib/auto-render.min.js"></script>


<link rel="stylesheet" href="style.css">
</head>
<body>

<div class="header">
  <button id="sidebar-toggle" style="background: none; border: none; color: white; font-size: 24px; cursor: pointer;">â˜°</button>
  <h1>Mars.ai</h1>
  <div></div>
</div>

<div class="sidebar">
  <nav class="nav">
    <a href="index.html">AI Tutor</a>
    <a href="decks.html">Decks</a>
    <a href="docs.html">Docs</a>
    <a href="quiz.html">Quiz</a>
    <a href="stats.html">Stats</a>
    <a href="community.html">Community</a>
    <a href="about.html">About</a>
    <a href="terms.html">Terms</a>
    <a href="#" id="account-link">Account</a>
  </nav>
</div>

<div class="main-section">
  <div class="main-container">
    <div class="page-header">
      <h1>AI Quizzes</h1>
    </div>

    <div class="quiz-generator">
      <button id="select-deck-btn" style="margin-bottom: 1rem; padding: 0.75rem 1.5rem; background: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer;">Select from Decks</button>
      <form id="quiz-form">
        <input type="hidden" id="selected-deck-id">
        <input type="text" id="topic" placeholder="Enter a topic" required>
        <select id="difficulty">
          <option value="" disabled selected>Select difficulty</option>
          <option value="easy">Easy</option>
          <option value="medium">Medium</option>
          <option value="hard">Hard</option>
        </select>
        <input type="number" id="num-questions" placeholder="Number of questions" min="1" max="20" required>
        <textarea id="context" placeholder="Optional: Provide additional context or specific areas to focus on"></textarea>
        <button type="submit" id="generate-btn">Generate Quiz</button>
      </form>
    </div>

    <div class="modal" id="quiz-modal">
      <div class="modal-content quiz-modal-content">
        <div class="quiz-section" id="quiz-section">
          <div id="quiz-content">
            <!-- Quiz questions will be loaded here -->
          </div>
          <div class="quiz-actions">
            <button id="prev-btn" onclick="previousQuestion()" disabled>Previous</button>
            <span id="question-counter">1 / 5</span>
            <button id="next-btn" onclick="nextQuestion()">Next</button>
            <button id="submit-btn" onclick="submitQuiz()" style="display: none;">Submit Quiz</button>
          </div>
        </div>
      </div>
    </div>

    <div class="results" id="results" style="display: none;">
      <h2>Quiz Complete!</h2>
      <div class="score" id="final-score"></div>
      <button onclick="resetQuiz()">Take Another Quiz</button>
    </div>

    <div class="modal" id="deck-select-modal">
      <div class="modal-content">
        <h2>Select a Deck for Quiz</h2>
        <div id="deck-list">
          <!-- Decks will be loaded here -->
        </div>
        <div class="modal-actions">
          <button onclick="closeDeckSelectModal()">Cancel</button>
        </div>
      </div>
    </div>
  </div>
  </div>
  
  <div class="modal" id="account-modal">
    <div class="modal-content">
      <h2>Account</h2>
      <div id="account-info">
        <!-- Account info will be loaded here -->
      </div>
    </div>
  </div>
  
  <script>
  const user = JSON.parse(localStorage.getItem('currentUser'));
  if (!user) {
    window.location.href = 'sign-in.html?redirect=' + encodeURIComponent(window.location.href);
  }
  
  let currentQuiz = [];
  let currentQuestionIndex = 0;
  let userAnswers = [];
  let quizSubmitted = false;
  let selectedDeck = null;

document.getElementById('quiz-form').addEventListener('submit', async (e) => {
  e.preventDefault();

  const topic = document.getElementById('topic').value.trim();
  const difficulty = document.getElementById('difficulty').value;
  const numQuestions = parseInt(document.getElementById('num-questions').value);
  const context = document.getElementById('context').value.trim();
  const selectedDeckId = document.getElementById('selected-deck-id').value;

  if (!topic && !selectedDeckId) {
    alert('Please enter a topic or select a deck.');
    return;
  }

  // Show loading
  document.getElementById('generate-btn').disabled = true;
  document.getElementById('generate-btn').textContent = 'Generating...';

  try {
    let prompt;
    if (selectedDeckId) {
      // Generate from deck
      const decks = JSON.parse(localStorage.getItem('flashcardDecks_' + user.id)) || [];
      const deck = decks.find(d => d.id == selectedDeckId);
      if (!deck || deck.cards.length === 0) {
        throw new Error('Selected deck has no cards.');
      }
      const cardsText = deck.cards.map(card => `Q: ${card.front} A: ${card.back}`).join('\n');
      prompt = `Generate a ${difficulty} difficulty quiz with ${numQuestions} multiple-choice questions based on these flashcards. ${context ? `Additional context: ${context}` : ''}

Flashcards:
${cardsText}

Format each question as:
Question: [question text]
A) [option 1]
B) [option 2]
C) [option 3]
D) [option 4]
Correct: [A/B/C/D]

Make questions educational and accurate. Use LaTeX for math equations if needed.`;
    } else {
      // Generate from topic
      prompt = `Generate a ${difficulty} difficulty quiz with ${numQuestions} multiple-choice questions about "${topic}". ${context ? `Additional context: ${context}` : ''}

Format each question as:
Question: [question text]
A) [option 1]
B) [option 2]
C) [option 3]
D) [option 4]
Correct: [A/B/C/D]

Make questions educational and accurate. Use LaTeX for math equations if needed.`;
    }

    const response = await fetch('https://api.groq.com/openai/v1/chat/completions', {
      method: 'POST',
      headers: {
        'Authorization': 'Bearer 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',
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        model: "meta-llama/llama-4-maverick-17b-128e-instruct",
        messages: [{ role: "user", content: prompt }],
        temperature: 0.7,
        max_tokens: 2048,
      }),
    });

    if (!response.ok) {
      throw new Error(`HTTP ${response.status}: ${response.statusText}`);
    }

    const data = await response.json();
    const quizText = data.choices[0]?.message?.content || '';

    // Parse the quiz
    currentQuiz = parseQuiz(quizText);
    userAnswers = new Array(currentQuiz.length).fill(null);

    if (currentQuiz.length === 0) {
      throw new Error('Failed to generate quiz. Please try again.');
    }

    // Show quiz
    document.getElementById('quiz-modal').classList.add('show');
    document.getElementById('results').style.display = 'none';
    currentQuestionIndex = 0;
    quizSubmitted = false;
    renderQuestion();

  } catch (error) {
    alert('Error generating quiz: ' + error.message);
  } finally {
    document.getElementById('generate-btn').disabled = false;
    document.getElementById('generate-btn').textContent = 'Generate Quiz';
  }
});

function parseQuiz(text) {
  const questions = [];
  const sections = text.split(/Question:/).slice(1);

  sections.forEach(section => {
    const lines = section.trim().split('\n');
    if (lines.length < 6) return;

    const question = lines[0].trim();
    const options = [];
    let correctAnswer = '';

    lines.slice(1).forEach(line => {
      if (line.startsWith('A) ') || line.startsWith('B) ') || line.startsWith('C) ') || line.startsWith('D) ')) {
        options.push(line.substring(3).trim());
      } else if (line.startsWith('Correct: ')) {
        correctAnswer = line.substring(9).trim();
      }
    });

    if (question && options.length === 4 && correctAnswer) {
      questions.push({
        question,
        options,
        correct: correctAnswer.charCodeAt(0) - 65 // Convert A/B/C/D to 0/1/2/3
      });
    }
  });

  return questions;
}

function renderQuestion() {
  const quizContent = document.getElementById('quiz-content');
  const question = currentQuiz[currentQuestionIndex];

  quizContent.innerHTML = `
    <div class="question">
      <h3>Question ${currentQuestionIndex + 1}</h3>
      <p>${question.question}</p>
      <div class="options">
        ${question.options.map((option, index) => `
          <div class="option ${userAnswers[currentQuestionIndex] === index ? 'selected' : ''} ${quizSubmitted ? (index === question.correct ? 'correct' : (userAnswers[currentQuestionIndex] === index ? 'incorrect' : '')) : ''}"
               onclick="selectOption(${index})">
            ${String.fromCharCode(65 + index)}) ${option}
          </div>
        `).join('')}
      </div>
    </div>
  `;

  // Render math
  renderMathInElement(quizContent, {
    delimiters: [
      {left: "$$", right: "$$", display: true},
      {left: "$", right: "$", display: false},
      {left: "\\(", right: "\\)", display: false}
    ]
  });

  updateNavigation();
}

function selectOption(optionIndex) {
  if (quizSubmitted) return;
  userAnswers[currentQuestionIndex] = optionIndex;
  renderQuestion();
}

function updateNavigation() {
  const counter = document.getElementById('question-counter');
  const prevBtn = document.getElementById('prev-btn');
  const nextBtn = document.getElementById('next-btn');
  const submitBtn = document.getElementById('submit-btn');

  counter.textContent = `${currentQuestionIndex + 1} / ${currentQuiz.length}`;
  prevBtn.disabled = currentQuestionIndex === 0;
  nextBtn.disabled = currentQuestionIndex === currentQuiz.length - 1;

  if (currentQuestionIndex === currentQuiz.length - 1) {
    nextBtn.style.display = 'none';
    submitBtn.style.display = 'inline-block';
  } else {
    nextBtn.style.display = 'inline-block';
    submitBtn.style.display = 'none';
  }
}

function nextQuestion() {
  if (currentQuestionIndex < currentQuiz.length - 1) {
    currentQuestionIndex++;
    renderQuestion();
  }
}

function previousQuestion() {
  if (currentQuestionIndex > 0) {
    currentQuestionIndex--;
    renderQuestion();
  }
}

function submitQuiz() {
  quizSubmitted = true;
  renderQuestion(); // Show correct/incorrect answers

  let correct = 0;
  userAnswers.forEach((answer, index) => {
    if (answer === currentQuiz[index].correct) correct++;
  });

  const score = Math.round((correct / currentQuiz.length) * 100);

  // Save to stats
  saveQuizResult(score, currentQuiz.length);

  // Show results
  document.getElementById('quiz-modal').classList.remove('show');
  document.getElementById('results').style.display = 'block';
  document.getElementById('final-score').textContent = `${correct}/${currentQuiz.length} (${score}%)`;
}

function resetQuiz() {
  document.getElementById('quiz-modal').classList.remove('show');
  document.getElementById('results').style.display = 'none';
  document.getElementById('quiz-form').reset();
  document.getElementById('selected-deck-id').value = '';
  currentQuiz = [];
  userAnswers = [];
  currentQuestionIndex = 0;
  quizSubmitted = false;
}

// Deck selection
document.getElementById('select-deck-btn').addEventListener('click', () => {
  openDeckSelectModal();
});

function openDeckSelectModal() {
  const modal = document.getElementById('deck-select-modal');
  const deckList = document.getElementById('deck-list');
  const decks = JSON.parse(localStorage.getItem('flashcardDecks_' + user.id)) || [];

  deckList.innerHTML = '';
  if (decks.length === 0) {
    deckList.innerHTML = '<p>No decks available. Create some flashcards first.</p>';
  } else {
    decks.forEach(deck => {
      const deckBtn = document.createElement('button');
      deckBtn.textContent = `${deck.name} (${deck.cards.length} cards)`;
      deckBtn.style.display = 'block';
      deckBtn.style.width = '100%';
      deckBtn.style.padding = '0.5rem';
      deckBtn.style.marginBottom = '0.5rem';
      deckBtn.style.background = '#6c757d';
      deckBtn.style.color = 'white';
      deckBtn.style.border = 'none';
      deckBtn.style.borderRadius = '4px';
      deckBtn.style.cursor = 'pointer';
      deckBtn.onclick = () => {
        selectDeck(deck);
      };
      deckList.appendChild(deckBtn);
    });
  }

  modal.classList.add('show');
}

function closeDeckSelectModal() {
  document.getElementById('deck-select-modal').classList.remove('show');
}

function selectDeck(deck) {
  document.getElementById('selected-deck-id').value = deck.id;
  document.getElementById('topic').value = deck.name;
  closeDeckSelectModal();
}

function saveQuizResult(score, total) {
  const stats = JSON.parse(localStorage.getItem('quizStats_' + user.id)) || [];
  stats.push({
    date: new Date().toISOString(),
    score: score,
    total: total
  });
  localStorage.setItem('quizStats_' + user.id, JSON.stringify(stats));
}

// Account modal functions
let outsideClickHandler;

function openAccountModal() {
  const modal = document.getElementById('account-modal');
  const info = document.getElementById('account-info');
  const user = JSON.parse(localStorage.getItem('currentUser'));
  if (user) {
    info.innerHTML = `<p>Signed in as: ${user.name}</p><button class="auth-btn" onclick="logout()">Logout</button><br><button onclick="closeAccountModal()" style="background: none; border: none; color: #6c757d; cursor: pointer; margin: 1rem auto 0; display: block; text-align: center;">Close</button>`;
  } else {
    info.innerHTML = `<p>Not signed in</p><button class="auth-btn" onclick="window.location.href='sign-in.html'">Sign In</button><br><button onclick="closeAccountModal()" style="background: none; border: none; color: #6c757d; cursor: pointer; margin: 1rem auto 0; display: block; text-align: center;">Close</button>`;
  }
  modal.classList.add('show');
  outsideClickHandler = function(e) {
    if (e.target.id === 'account-modal') {
      closeAccountModal();
    }
  };
  document.addEventListener('click', outsideClickHandler);
}

function closeAccountModal() {
  document.getElementById('account-modal').classList.remove('show');
  if (outsideClickHandler) {
    document.removeEventListener('click', outsideClickHandler);
    outsideClickHandler = null;
  }
}

function logout() {
  localStorage.removeItem('currentUser');
  closeAccountModal();
  window.location.href = 'sign-in.html';
}

// Event listener for account link
document.getElementById('account-link').addEventListener('click', function(e) {
  e.preventDefault();
  openAccountModal();
});

// Sidebar toggle
document.getElementById('sidebar-toggle').addEventListener('click', () => {
  document.body.classList.toggle('sidebar-open');
  localStorage.setItem('sidebarOpen', document.body.classList.contains('sidebar-open'));
});

// Initialize sidebar state
if (localStorage.getItem('sidebarOpen') === 'true') {
  document.body.classList.add('sidebar-open');
}
document.body.classList.add('sidebar-initialized');

// Close sidebar when clicking outside
document.addEventListener('click', (e) => {
  const sidebar = document.querySelector('.sidebar');
  const toggle = document.getElementById('sidebar-toggle');
  const accountModal = document.getElementById('account-modal');
  if (!sidebar.contains(e.target) && !toggle.contains(e.target) && document.body.classList.contains('sidebar-open') && !accountModal.classList.contains('show')) {
    document.body.classList.remove('sidebar-open');
    localStorage.setItem('sidebarOpen', false);
  }
});
</script>

<script>
  const toggle = document.getElementById('sidebar-toggle');
  toggle.addEventListener('click', () => {
    document.body.classList.toggle('sidebar-closed');
  });
</script>

</body>
</html>