<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Mars.ai - Sign In</title>

<link rel="stylesheet" href="style.css">
<script src="https://accounts.google.com/gsi/client" async defer></script>
</head>
<body class="sign-in-page">

<div class="main-section">
  <div class="left-panel">
    <h1>Mars AI</h1>
    <p>Developed by Crystal Cabanatan</p>
  </div>
  <div class="main-container">
  <div class="user-info" id="user-info" style="display: none;">
    <h3 id="username"></h3>
    <button class="auth-btn" onclick="window.location.href='index.html'">Go to Home</button>
  </div>

  <div id="auth-forms">
    <h2>Sign In</h2>
    <div id="google-signin-btn"></div>
  </div>
</div>

<script>
let currentUser = null;

// Show message function
function showMessage(message, type) {
  // Simple alert for now, or you can implement a proper message display
  alert(message);
}

// Check if user is already signed in
function checkAuth() {
  const user = JSON.parse(localStorage.getItem('currentUser'));
  if (user) {
    const urlParams = new URLSearchParams(window.location.search);
    const redirect = urlParams.get('redirect');
    if (redirect) {
      window.location.href = decodeURIComponent(redirect);
      return;
    }
    // Show user info instead of redirecting immediately
    document.getElementById('username').textContent = `Welcome back, ${user.name}!`;
    document.getElementById('user-info').style.display = 'block';
    document.getElementById('auth-forms').style.display = 'none';
  }
}

// Decode JWT response
function decodeJwtResponse(token) {
  var base64Url = token.split('.')[1];
  var base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
  var jsonPayload = decodeURIComponent(atob(base64).split('').map(function(c) {
    return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
  }).join(''));
  return JSON.parse(jsonPayload);
}

// Google Sign-In callback
function handleCredentialResponse(response) {
  const responsePayload = decodeJwtResponse(response.credential);
  const user = {
    id: responsePayload.sub,
    name: responsePayload.name,
    email: responsePayload.email,
    image: responsePayload.picture,
    provider: 'google'
  };

  currentUser = user;
  localStorage.setItem('currentUser', JSON.stringify(user));
  showMessage('Successfully signed in with Google!', 'success');
  setTimeout(() => {
    const urlParams = new URLSearchParams(window.location.search);
    const redirect = urlParams.get('redirect');
    window.location.href = redirect ? decodeURIComponent(redirect) : 'index.html';
  }, 2000);
}

// Logout
function logout() {
  currentUser = null;
  localStorage.removeItem('currentUser');
  window.location.href = 'sign-in.html';
}

// Initialize Google Identity Services
window.onload = function() {
  google.accounts.id.initialize({
    client_id: '431515268389-7pouo7emgdpq7185pqlsg50jvv3ushth.apps.googleusercontent.com',
    callback: handleCredentialResponse
  });

  google.accounts.id.renderButton(
    document.getElementById('google-signin-btn'),
    { theme: 'filled_black', size: 'large', text: 'signin_with', shape: 'rectangular' }
  );
};

// Initialize
checkAuth();
</script>

</body>
</html>
